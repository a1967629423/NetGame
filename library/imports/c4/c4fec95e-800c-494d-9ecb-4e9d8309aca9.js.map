{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\script\\manage\\states/assets\\script\\manage\\states\\ClearManageStates.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\script\\manage\\states","sourcesContent":["import { MSMDsc } from \"../../../frame/StateMachine/StateDec\";\r\nimport { LineClear } from \"../LineClearManage\";\r\nimport { MSM } from \"../../../frame/StateMachine/StateMachine\";\r\nimport { SLDSM } from \"../../site/SiteLine\";\r\nconst {LineClearManage,LineClearState}=LineClear\r\nconst {mDefaultState,mLinkTo,mState,mAttach,mUnique}=MSMDsc\r\nconst {AwaitNextUpdate}=MSM\r\nconst {SiteLine}=SLDSM\r\nexport module ClearManageStates\r\n{\r\n    \r\n    @mDefaultState\r\n    @mLinkTo('Clear','clear')\r\n    @mState('Default',LineClearManage)\r\n    export class Default extends LineClearState\r\n    {\r\n\r\n    }\r\n    @mLinkTo('Default','clearEnd')\r\n    @mState('Clear',LineClearManage)\r\n    export class Clear extends LineClearState\r\n    {\r\n        haveTageLines:SLDSM.SiteLine[] = []\r\n        wellBeClaer:SLDSM.SiteLine[] = []\r\n        checkLineHaveClearFlag()\r\n        {\r\n            SiteLine.SiteLines.forEach(lineStruct=>{\r\n                lineStruct.lines.forEach(line=>{\r\n                    if(line.ClearFlag&&!this.haveTageLines.find(value=>value===line))\r\n                    {\r\n                        this.haveTageLines.push(line);\r\n                    }\r\n                });\r\n            })\r\n        }\r\n        updateMaskAndClear()\r\n        {\r\n            var saveLine:SLDSM.SiteLine[] = []\r\n            SiteLine.LineVehicles.forEach(value=>{\r\n                value.Vehicles.forEach(vehicle=>{\r\n                    var vline = vehicle.line;\r\n                    saveLine.push(vline);\r\n                    var rundir = vehicle.rundir;\r\n                    if(vline.isBegin)\r\n                    {\r\n                        var nl = vline.NextLine;\r\n                        saveLine.push(nl);\r\n                    }\r\n                    if(vline.NextLine&&vline.NextLine.isEnd&&rundir)\r\n                    {\r\n                        saveLine.push(vline.NextLine);\r\n                    }\r\n                    if(vline.LastLine&&vline.LastLine.isBegin&&!rundir)\r\n                    {\r\n                        saveLine.push(vline.LastLine);\r\n                    }\r\n\r\n                })\r\n            });\r\n            for(var i = this.haveTageLines.length-1;i>=0;i--)\r\n            {\r\n                var tl = this.haveTageLines[i];\r\n                if(!saveLine.find(v=>v===tl))\r\n                {\r\n                    tl.recycle();\r\n                    this.haveTageLines.splice(i);\r\n                }\r\n            }\r\n        }\r\n        Start()\r\n        {\r\n            this.checkLineHaveClearFlag();\r\n            this.context.node.on('clear',this.checkLineHaveClearFlag,this);\r\n            this.context.startCoroutine_Auto((function*(_this){\r\n                while(true)\r\n                {\r\n                    yield AwaitNextUpdate.getInstance(1);\r\n                    if(_this.haveTageLines.length==0)\r\n                    {\r\n                        _this.context.emit('clearEnd');\r\n                        break;\r\n                    }\r\n                    _this.updateMaskAndClear();\r\n                    \r\n                    \r\n                }\r\n            })(this));\r\n        }\r\n        Quit()\r\n        {\r\n            this.context.node.off('clear',this.checkLineHaveClearFlag,this);\r\n        }\r\n    }\r\n    @mUnique\r\n    @mAttach('change')\r\n    @mState('Change',LineClearManage)\r\n    export class Change extends LineClearState\r\n    {\r\n        haveTageLines:SLDSM.SiteLine[] = []\r\n        checkLIneHaveChangeFlag()\r\n        {\r\n            SLDSM.SiteLine.SiteLines.forEach(Linestruct=>{\r\n                Linestruct.lines.forEach(line=>{\r\n                    \r\n                })\r\n            })\r\n        }\r\n        Start()\r\n        {\r\n            this.context.node.on('change',this.checkLIneHaveChangeFlag,this);\r\n            this.context.startCoroutine_Auto((function*(_this){\r\n                while(true)\r\n                {\r\n                    yield AwaitNextUpdate.getInstance();\r\n                    if(_this.haveTageLines.length===0)\r\n                    {\r\n                        _this.done();\r\n                        break;\r\n                    }\r\n                }\r\n            })(this));\r\n        }\r\n        Quit()\r\n        {\r\n            this.context.node.off('change',this.checkLIneHaveChangeFlag,this);\r\n        }\r\n    }\r\n}"]}