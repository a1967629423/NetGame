{"version":3,"sources":["PathSM.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\assets\\script\\Path","sourcesContent":["import { SiteSM } from \"../site/SiteMachine\";\r\nimport ObjectPool, { IObpool } from \"../../frame/ObjectPool/ObjectPool\";\r\nimport { SiteLineType } from \"../Enums\";\r\nimport { Vehicle } from \"../vehicle/VehicleMachine\";\r\nexport module Path {\r\n    /**\r\n * 载具路线类\r\n * 储存:所有线路，上一个以及下一个线路，处于线路上的载具，当前状态遮罩\r\n * 功能:获取此线路上的中间插值点\r\n */\r\n    export class VehiclePath implements IObpool {\r\n        /**\r\n         * 当路线从对象池中取出之后会注册到此数组中\r\n         */\r\n        static allPath: VehiclePath[] = [];\r\n        unuse(value?: any) {\r\n            this.lastSite = null;\r\n            this.nextSite = null;\r\n            this.mask = 0;\r\n            var idx = -1;\r\n            this.allLength = 0;\r\n            this.changePoint = [];\r\n            if (VehiclePath.allPath.some((v, index) => {\r\n                if (v === this) {\r\n                    idx = index;\r\n                    return true;\r\n                }\r\n            })) {\r\n                VehiclePath.allPath.splice(idx);\r\n            }\r\n        }\r\n        reuse(lastSite: SiteSM.SiteMachine, nextSite: SiteSM.SiteMachine, Type: SiteLineType) {\r\n            if(lastSite&&nextSite&&Type)\r\n            {\r\n                if(lastSite instanceof SiteSM.SiteMachine)\r\n                {\r\n                    this.lastSite = lastSite;\r\n                    this.nextSite = nextSite;\r\n                    this.PathType = Type;\r\n                    VehiclePath.allPath.push(this);\r\n                    this.caculatePath(lastSite.node.position,nextSite.node.position);\r\n                }\r\n                else if(lastSite['x']&&nextSite['x'])\r\n                {\r\n                    this.PathType = Type;\r\n                    this.caculatePath(<any>lastSite,<any>nextSite);\r\n                }\r\n            }\r\n           \r\n        }\r\n        recycle(value?: any) {\r\n            ObjectPool.GlobalPush(this);\r\n        }\r\n\r\n        lastSite: SiteSM.SiteMachine = null;\r\n        nextSite: SiteSM.SiteMachine = null;\r\n        /**\r\n         * 1111\r\n         * cdhb\r\n         * c:changed\r\n         * d:deleted\r\n         * h:hided\r\n         * b:blocked\r\n         */\r\n        mask: number = 0;\r\n        /**线的类型 */\r\n        PathType: SiteLineType = SiteLineType.red;\r\n        /**线的总长度 */\r\n        allLength: number = 0;\r\n        /**中转点 */\r\n        changePoint: { length: number, point: cc.Vec2, Radian: number }[] = [];\r\n        /**载具集合 */\r\n        vehicles: Vehicle.VehicleMachine[] = [];\r\n        get isEnd():boolean\r\n        {\r\n            return !this.nextSite.SiteLines.some(v=>v.PathType===this.PathType&&v!==this&&v.lastSite===this.nextSite);\r\n        }\r\n        get isBegin():boolean\r\n        {\r\n            return !this.lastSite.SiteLines.some(v=>v.PathType===this.PathType&&v!==this&&v.nextSite===this.lastSite);\r\n        }\r\n        get NextPath():VehiclePath\r\n        {\r\n            return this.nextSite.SiteLines.find(v=>v.PathType===this.PathType&&v!==this&&!(v.mask&1)&&!(v.mask&4));\r\n        }\r\n        get LastPath():VehiclePath\r\n        {\r\n            return this.lastSite.SiteLines.find(v=>v.PathType===this.PathType&&v!==this&&!(v.mask&1)&&!(v.mask&4));\r\n        }\r\n        get ClearFlag():boolean\r\n        {\r\n            return !!(this.mask&8);\r\n        }\r\n        caculatePath(n:cc.Vec2,e:cc.Vec2) {\r\n            var Line = this;\r\n            var { x, y, allLength, firstRadian, lastRadian, rectDir, rectH, rectW } = DMath.pathCalcaulate(n.x, n.y, e.x, e.y)\r\n            Line.allLength = allLength;\r\n            Line.changePoint = []\r\n            Line.changePoint.push({length:0,point:n,Radian:firstRadian});\r\n            Line.changePoint.push({ length: rectDir ? rectW : rectH, point: cc.v2(x, y), Radian: firstRadian })\r\n            Line.changePoint.push({ length: allLength, point: e, Radian: lastRadian });\r\n        }\r\n        __np: cc.Vec2 = cc.v2();\r\n        /**\r\n         * 根据运行方向以及进度获取坐标，此坐标为站点集对象下的坐标\r\n         * @param progress 当前的进度(前进的距离)\r\n         * @param dir 运行的方向\r\n         */\r\n        getLocation(progress: number, dir: boolean = true): { position: cc.Vec2, radian: number } {\r\n            //需要改动\r\n            var nLine = this;\r\n            var narr = nLine.changePoint//dir?this.changPoint:this.rchangePoint\r\n            var nprogress = dir ? progress : nLine.allLength - progress;\r\n            var idx = narr.findIndex(value => value.length >= nprogress)\r\n            var cp = narr[idx]\r\n            var lastp = this.lastSite.node.position;\r\n            var nLenght = cp.length;\r\n            if (idx >= 1) {\r\n                lastp = narr[idx - 1].point;\r\n                nprogress -= narr[idx - 1].length\r\n                nLenght -= narr[idx - 1].length\r\n            }\r\n            if (!this.__np) this.__np = cc.v2();\r\n            lastp.lerp(cp.point, nprogress / nLenght, this.__np) //dir?lastp.lerp(cp.point,cl):cp.point.lerp(lastp,cl);\r\n            return { position: this.__np, radian: cp.Radian + (dir ? 0 : Math.PI) };\r\n        }\r\n        /**\r\n         * 当载具换线时需要注册\r\n         * @param v 载具\r\n         */\r\n        addVehicle(v: Vehicle.VehicleMachine) {\r\n            if (v instanceof Vehicle.VehicleMachine) {\r\n                this.vehicles.push(v);\r\n            }\r\n        }\r\n        /**\r\n         * 当载具离开时需要注销\r\n         * @param v 载具\r\n         */\r\n        removeVehicle(v: Vehicle.VehicleMachine) {\r\n            if (v instanceof Vehicle.VehicleMachine) {\r\n                var idx = this.vehicles.findIndex(value => value === v);\r\n                if (idx > -1)\r\n                    this.vehicles.splice(idx);\r\n            }\r\n        }\r\n    }\r\n\r\n}\r\n"]}